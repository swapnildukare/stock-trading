name: Swing Pipeline

on:
  # 4:00 PM IST = 10:30 AM UTC, weekdays
  schedule:
    - cron: "30 10 * * 1-5"
  # Manual trigger — backfill by lookback days or explicit date range
  workflow_dispatch:
    inputs:
      lookback_days:
        description: "Lookback days from today (ignored if from_date is set)"
        required: false
        default: "1"
      from_date:
        description: "Start date YYYY-MM-DD (overrides lookback_days)"
        required: false
        default: ""
      to_date:
        description: "End date YYYY-MM-DD (default: today)"
        required: false
        default: ""

jobs:
  run-pipeline:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          # Full history needed so git push works cleanly
          fetch-depth: 0

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        run: uv sync

      - name: Run swing pipeline
        working-directory: swing_trading_1
        run: |
          # Cron runs: no inputs, pipeline auto-catchup handles it (no extra args needed)
          # Manual runs: build --from / --to from inputs
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # Resolve to_date (default: today)
            TO="${{ inputs.to_date }}"
            if [ -z "$TO" ]; then
              TO=$(date -u +%Y-%m-%d)
            fi

            # Resolve from_date (explicit wins over lookback_days)
            FROM="${{ inputs.from_date }}"
            if [ -z "$FROM" ]; then
              DAYS="${{ inputs.lookback_days }}"
              FROM=$(date -u -d "$TO - ${DAYS} days" +%Y-%m-%d 2>/dev/null \
                  || date -u -v-${DAYS}d +%Y-%m-%d)   # macOS fallback
            fi

            echo "Running pipeline from $FROM to $TO"
            uv run python -m src.pipeline --from "$FROM" --to "$TO"
          else
            # Scheduled run — no args, pipeline auto-calculates missing dates
            uv run python -m src.pipeline
          fi

      - name: Commit updated DuckDB
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add swing_trading_1/data/market.duckdb
          # Only commit if there are actual changes
          git diff --cached --quiet && echo "No DB changes" || \
            git commit -m "chore: update market.duckdb $(date -u +'%Y-%m-%d') [skip ci]"

      - name: Push changes
        run: git push origin ${{ github.ref_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload pipeline logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pipeline-logs-${{ github.run_id }}
          path: swing_trading_1/logs/
          retention-days: 30
          if-no-files-found: ignore
